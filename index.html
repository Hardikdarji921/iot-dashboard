<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IoT Device Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-router-dom@6.26.2/dist/umd/react-router-dom.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
  <style>
    .error-boundary { color: red; padding: 20px; text-align: center; }
    .loading { text-align: center; padding: 20px; }
  </style>
</head>
<body>
  <div id="root"><div class="loading">Loading...</div></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { BrowserRouter, Routes, Route, Link } = ReactRouterDOM;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } = Recharts;

    const firebaseConfig = {
      apiKey: "AIzaSyDcRpos41afSTVavx3ZqFECcGW-2phqhNQ",
      authDomain: "sensor-monitoring-a093a.firebaseapp.com",
      databaseURL: "https://sensor-monitoring-a093a-default-rtdb.firebaseio.com",
      projectId: "sensor-monitoring-a093a",
      storageBucket: "sensor-monitoring-a093a.appspot.com",
      messagingSenderId: "660525836251",
      appId: "1:660525836251:web:6281777b8417b22c1a29fe"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function formatTimestamp(ts) {
      return ts.replace("T", " ").replace(/-/g, ":").replace(/:(\d\d)$/, "-$1");
    }

    function DevicePage() {
      const deviceId = 'device1';
      const [sensorData, setSensorData] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        const ref = database.ref(`sensordata/${deviceId}`);
        ref.on('value', snapshot => {
          try {
            const data = snapshot.val();
            if (data) {
              const dataList = Object.entries(data).map(([timestamp, fields]) => ({
                timestamp,
                ...fields
              }));
              setSensorData(dataList);
            } else {
              setSensorData([]);
            }
          } catch (err) {
            setError("Error reading data: " + err.message);
          }
        }, err => {
          setError("DB Error: " + err.message);
        });

        return () => ref.off();
      }, []);

      const downloadCSV = () => {
        try {
          const csvData = sensorData.map(item => ({
            timestamp: item.timestamp,
            analog4: item.analog4,
            battery: item.battery,
            dhtTemp: item.dhtTemp,
            dhtHum: item.dhtHum,
            eco2: item.eco2,
            latitude: item.latitude,
            longitude: item.longitude,
            mq135: item.mq135,
            mq2: item.mq2,
            mq6: item.mq6,
            tvoc: item.tvoc
          }));
          const csv = Papa.unparse(csvData);
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${deviceId}_data.csv`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert("CSV download failed: " + err.message);
        }
      };

      if (error) return <div className="error-boundary">{error}</div>;
      if (!sensorData.length) return <div className="loading">Loading data...</div>;

      return (
        <div className="container mx-auto p-4">
          <h1 className="text-2xl font-bold mb-4">Device: {deviceId}</h1>
          <button
            onClick={downloadCSV}
            className="mb-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            Download CSV
          </button>

          <table className="w-full border-collapse mb-6">
            <thead>
              <tr className="bg-gray-200">
                <th className="border p-2">Timestamp</th>
                <th className="border p-2">Analog4</th>
                <th className="border p-2">Battery</th>
                <th className="border p-2">dhtTemp</th>
                <th className="border p-2">dhtHum</th>
                <th className="border p-2">eco2</th>
                <th className="border p-2">Lat</th>
                <th className="border p-2">Lon</th>
                <th className="border p-2">mq135</th>
                <th className="border p-2">mq2</th>
                <th className="border p-2">mq6</th>
                <th className="border p-2">tvoc</th>
              </tr>
            </thead>
            <tbody>
              {sensorData.map((item, idx) => (
                <tr key={idx}>
                  <td className="border p-2">{formatTimestamp(item.timestamp)}</td>
                  <td className="border p-2">{item.analog4}</td>
                  <td className="border p-2">{item.battery}</td>
                  <td className="border p-2">{item.dhtTemp}</td>
                  <td className="border p-2">{item.dhtHum}</td>
                  <td className="border p-2">{item.eco2}</td>
                  <td className="border p-2">{item.latitude}</td>
                  <td className="border p-2">{item.longitude}</td>
                  <td className="border p-2">{item.mq135}</td>
                  <td className="border p-2">{item.mq2}</td>
                  <td className="border p-2">{item.mq6}</td>
                  <td className="border p-2">{item.tvoc}</td>
                </tr>
              ))}
            </tbody>
          </table>

          <h2 className="text-xl font-semibold mb-2">eco2 Trend</h2>
          <LineChart width={700} height={300} data={sensorData} className="mx-auto">
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="timestamp" tickFormatter={formatTimestamp} />
            <YAxis />
            <Tooltip />
            <Legend />
            <Line type="monotone" dataKey="eco2" stroke="#8884d8" />
          </LineChart>
        </div>
      );
    }

    function App() {
      return (
        <BrowserRouter>
          <Routes>
            <Route path="/" element={<DevicePage />} />
          </Routes>
        </BrowserRouter>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
